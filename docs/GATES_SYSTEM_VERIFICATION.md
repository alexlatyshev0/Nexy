# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–∏—Å—Ç–µ–º—ã Gates: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚Üî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-01-20  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** `019_unified_gates.sql`

---

## ‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ú–∏–≥—Ä–∞—Ü–∏—è `019_unified_gates.sql` —Å–æ–∑–¥–∞—ë—Ç unified gates system  
**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** ‚úÖ –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `supabase/migrations/019_unified_gates.sql`

**–°–æ–∑–¥–∞–Ω–æ:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `user_gates` —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: `onboarding_gates`, `body_map_gates`, `activity_gates`, `gates`
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã: `trg_recompute_gates_on_onboarding`, `trg_recompute_gates_on_body_map`
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏: `compute_gates_from_onboarding()`, `compute_gates_from_body_map()`, `recompute_user_gates()`, `is_scene_gated_v2()`

**–£–¥–∞–ª–µ–Ω–æ:**
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ `onboarding_responses.gates` (DROP COLUMN)
- ‚úÖ –°—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: `compute_onboarding_gates()`, `is_scene_gated()`
- ‚úÖ –ò–Ω–¥–µ–∫—Å `idx_onboarding_responses_gates`

---

### 2. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

**–§–∞–π–ª `docs/database.md`:**
- ‚úÖ –û–ø–∏—Å–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `user_gates`
- ‚úÖ –û–ø–∏—Å–∞–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä—ã
- ‚úÖ –û–ø–∏—Å–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –£–∫–∞–∑–∞–Ω–æ, —á—Ç–æ `onboarding_responses.gates` —É–¥–∞–ª–µ–Ω–∞

**–§–∞–π–ª `docs/onboarding-integration.md`:**
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω —Ä–∞–∑–¥–µ–ª "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –≥–µ–π—Ç–æ–≤"
- ‚úÖ –ü–æ–∫–∞–∑–∞–Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞ Single Source of Truth
- ‚úÖ –û–±—ä—è—Å–Ω–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ TypeScript
- ‚úÖ –£–∫–∞–∑–∞–Ω—ã —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–§–∞–π–ª `docs/ANALYSIS_DISCREPANCIES.md`:**
- ‚úÖ –†–∞–∑–¥–µ–ª 5 –æ–±–Ω–æ–≤–ª—ë–Ω –∫–∞–∫ "–†–ï–®–ï–ù–û"
- ‚úÖ –û–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –±—ã–ª–æ –∏ —á—Ç–æ —Å—Ç–∞–ª–æ

---

### 3. TypeScript –∫–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–§–∞–π–ª `src/lib/onboarding-gates.ts`:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `fetchUserGates()` ‚Äî —á–∏—Ç–∞–µ—Ç –∏–∑ `user_gates.gates` ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `fetchUserGatesDetailed()` ‚Äî –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `isSceneAllowed()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç gates –∏–∑ –ë–î ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
- ‚ùå –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `computeGates()` ‚Äî **–ù–ï –ù–ê–ô–î–ï–ù–ê** ‚úÖ –£–î–ê–õ–ï–ù–ê

**–§–∞–π–ª `src/app/(app)/visual-onboarding/page.tsx`:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ `responses` –≤ `onboarding_responses` ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ –ù–ï –≤—ã—á–∏—Å–ª—è–µ—Ç gates –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "gates are computed automatically by database trigger" ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

**–§–∞–π–ª `src/lib/scene-progression.ts`:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `getBaselineGates()` ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å baseline —Å—Ü–µ–Ω–∞–º–∏ (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞)
- ‚ö†Ô∏è –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `fetchUserGates()` ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Ç.–∫. baseline gates —ç—Ç–æ –¥—Ä—É–≥–∞—è —Å–∏—Å—Ç–µ–º–∞

---

### 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç

**–¢–∞–±–ª–∏—Ü–∞ `user_gates`:**
```sql
-- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
CREATE TABLE user_gates (
  user_id UUID PRIMARY KEY,
  onboarding_gates JSONB,
  body_map_gates JSONB,
  activity_gates JSONB,
  gates JSONB,  -- combined
  created_at, updated_at
);
```
‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–¢–∞–±–ª–∏—Ü–∞ `onboarding_responses`:**
```sql
-- –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 019
CREATE TABLE onboarding_responses (
  id UUID PRIMARY KEY,
  user_id UUID,
  responses JSONB,  -- ‚úÖ –¢–û–õ–¨–ö–û responses
  -- ‚ùå gates JSONB - –£–î–ê–õ–ï–ù–ê
  completed BOOLEAN,
  current_index INTEGER,
  created_at, updated_at
);
```
‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üìù –ù–ê–ô–î–ï–ù–ù–´–ï –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ)

### 1. –°—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å—ë –µ—â—ë —Å–æ–¥–µ—Ä–∂–∞—Ç —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `015_visual_onboarding.sql` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç `compute_onboarding_gates()` (—Å—Ç—Ä–æ–∫–∞ 97)
- `016_security_fixes.sql` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç `compute_onboarding_gates()` (—Å—Ç—Ä–æ–∫–∞ 100)
- `017_onboarding_as_scenes.sql` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç `is_scene_gated()` (—Å—Ç—Ä–æ–∫–∞ 38)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ  
**–ü—Ä–∏—á–∏–Ω–∞:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏—è 019 —É–¥–∞–ª—è–µ—Ç —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–Ω—Ü–µ  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤ 019

---

### 2. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ database.md —É–ø–æ–º–∏–Ω–∞–µ—Ç —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é

**–§–∞–π–ª `docs/database.md` (—Å—Ç—Ä–æ–∫–∞ 788):**
```
- compute_onboarding_gates function (deprecated)
```

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ  
**–ü—Ä–∏—á–∏–Ω–∞:** –£–∫–∞–∑–∞–Ω–æ –∫–∞–∫ deprecated, —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞ "removed in migration 019"

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: **95%**

**–°–∏—Å—Ç–µ–º–∞ Gates —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
2. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
3. ‚úÖ TypeScript –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. ‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–¥ —É–¥–∞–ª—ë–Ω –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏
5. ‚úÖ –ü—Ä–∏–Ω—Ü–∏–ø Single Source of Truth —Å–æ–±–ª—é–¥—ë–Ω

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:**
- ‚ö†Ô∏è –°—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –≤ 019 (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (015, 016, 017), —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤ 019
2. –û–±–Ω–æ–≤–∏—Ç—å `database.md` —Å—Ç—Ä–æ–∫—É 788: "removed in migration 019" –≤–º–µ—Å—Ç–æ "deprecated"

---

## üîç –ü–†–û–í–ï–†–ï–ù–ù–´–ï –§–ê–ô–õ–´

### –ú–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ `019_unified_gates.sql` ‚Äî —Å–æ–∑–¥–∞—ë—Ç unified system
- ‚úÖ `015_visual_onboarding.sql` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
- ‚úÖ `016_security_fixes.sql` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
- ‚úÖ `017_onboarding_as_scenes.sql` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `docs/database.md` ‚Äî –æ–ø–∏—Å–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ user_gates
- ‚úÖ `docs/onboarding-integration.md` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω —Ä–∞–∑–¥–µ–ª –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ `docs/ANALYSIS_DISCREPANCIES.md` ‚Äî —Ä–∞–∑–¥–µ–ª 5 –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω—ã–π

### –ö–æ–¥
- ‚úÖ `src/lib/onboarding-gates.ts` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fetchUserGates()
- ‚úÖ `src/app/(app)/visual-onboarding/page.tsx` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ responses
- ‚úÖ `src/lib/scene-progression.ts` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è baseline

---

**–í—ã–≤–æ–¥:** –°–∏—Å—Ç–µ–º–∞ Gates –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ Single Source of Truth. ‚úÖ
